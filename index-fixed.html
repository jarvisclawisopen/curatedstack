<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CuratedStack - Windows 95 Style</title>
  <link rel="icon" href="logo.svg">
  
  <!-- 98.css Windows 95 Framework -->
  <link rel="stylesheet" href="https://unpkg.com/98.css">
  
  <style>
    body {
      background: teal;
      margin: 0;
      padding: 20px;
      padding-bottom: 50px;
    }
    
    .main-window {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Category Sections */
    .category-section {
      margin-bottom: 30px;
      animation: sectionSlideIn 0.4s ease-out;
    }
    
    .category-header {
      background: linear-gradient(90deg, #000080, #1084d0);
      color: white;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 12px;
      border: 2px solid;
      border-color: #ffffff #000000 #000000 #ffffff;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .category-header:hover {
      background: linear-gradient(90deg, #1084d0, #000080);
    }
    
    .category-header .count {
      background: yellow;
      color: black;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    /* App Window with entrance animation */
    .app-window {
      position: relative;
      animation: windowPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform-origin: top left;
    }
    
    @keyframes windowPop {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @keyframes sectionSlideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Hover wiggle effect */
    .app-window:hover {
      animation: windowWiggle 0.5s ease;
    }
    
    @keyframes windowWiggle {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(1deg); }
      75% { transform: rotate(-1deg); }
    }
    
    /* Featured App */
    .app-window.featured {
      animation: glow 2s ease-in-out infinite, windowPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .app-window.featured::before {
      content: "‚≠ê FEATURED ‚≠ê";
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: yellow;
      padding: 4px 16px;
      font-weight: bold;
      border: 2px outset;
      z-index: 10;
      animation: bounce 1s ease infinite;
    }
    
    .app-window.featured .title-bar {
      background: linear-gradient(90deg, red, orange, yellow, orange, red);
      background-size: 200% 100%;
      animation: rainbow 3s linear infinite;
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 10px yellow; }
      50% { box-shadow: 0 0 30px yellow; }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-5px); }
    }
    
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    
    .app-icon {
      width: 48px;
      height: 48px;
      object-fit: contain;
      image-rendering: pixelated;
      border: 1px solid #808080;
    }
    
    .app-content {
      display: flex;
      gap: 12px;
      margin: 8px 0;
    }
    
    .app-details {
      flex: 1;
      min-width: 0;
    }
    
    .app-description {
      font-size: 11px;
      margin: 4px 0;
      color: #000;
      line-height: 1.4;
    }
    
    .app-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    
    .tag {
      font-size: 9px;
      padding: 2px 6px;
      background: #c0c0c0;
      border: 1px solid #808080;
      white-space: nowrap;
    }
    
    .app-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #808080;
      flex-wrap: wrap;
    }
    
    .upvote-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    
    .upvote-btn.upvoted {
      background: navy;
      color: white;
    }
    
    .stars-container {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }
    
    .stars {
      display: flex;
      gap: 2px;
    }
    
    .star {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      color: #808080;
      line-height: 1;
      transition: transform 0.1s;
    }
    
    .star:hover {
      transform: scale(1.2);
    }
    
    .star:active {
      transform: scale(0.9);
    }
    
    .star.filled {
      color: gold;
      text-shadow: 0 0 3px orange;
    }
    
    .rating-value {
      font-size: 10px;
      color: #000;
      font-weight: bold;
      min-width: 25px;
    }
    
    /* Taskbar */
    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 28px;
      display: flex;
      align-items: center;
      padding: 2px;
      gap: 2px;
      z-index: 9999;
    }
    
    .start-button {
      padding: 2px 8px !important;
      font-weight: bold !important;
    }
    
    .start-button:active {
      background: #c0c0c0 !important;
    }
    
    .clock {
      margin-left: auto;
      padding: 2px 8px;
      border: 1px inset;
      font-size: 11px;
    }
    
    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    #search-input {
      flex: 1;
      max-width: 300px;
      min-width: 200px;
    }
    
    #category-filter {
      min-width: 150px;
    }
    
    .status-bar-field {
      padding: 2px 8px;
    }
    
    /* Loading skeleton animation */
    @keyframes shimmer {
      0% { background-position: -400px 0; }
      100% { background-position: 400px 0; }
    }
    
    .skeleton {
      background: linear-gradient(90deg, #c0c0c0 0%, #ffffff 50%, #c0c0c0 100%);
      background-size: 400px 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }
  </style>
</head>
<body>

<!-- Main Application Window -->
<div class="main-window window" style="width: 100%;">
  <div class="title-bar">
    <div class="title-bar-text">
      <img src="logo.svg" width="16" height="16" alt="CuratedStack" onerror="this.style.display='none'">
      CuratedStack - Curated Apps Directory
    </div>
    <div class="title-bar-controls">
      <button aria-label="Minimize" disabled></button>
      <button aria-label="Maximize" disabled></button>
      <button aria-label="Close" disabled></button>
    </div>
  </div>
  
  <div class="window-body">
    <!-- Toolbar -->
    <div class="toolbar">
      <label for="search-input">Find:</label>
      <input id="search-input" type="text" placeholder="Search apps..." />
      <button id="search-btn">Search</button>
      <select id="category-filter">
        <option value="all">All Categories</option>
      </select>
    </div>
    
    <!-- Stats -->
    <div class="status-bar">
      <div class="status-bar-field">
        <span id="total-apps">0</span> apps
      </div>
      <div class="status-bar-field">
        <span id="total-upvotes">0</span> total upvotes
      </div>
      <div class="status-bar-field">
        Avg rating: <span id="avg-rating">‚Äî</span>‚≠ê
      </div>
    </div>
    
    <!-- App Grid (categorized) -->
    <div id="app-container"></div>
  </div>
</div>

<!-- Taskbar -->
<div class="taskbar window">
  <button class="start-button" onclick="playSound('startup')">
    <b>Start</b>
  </button>
  <div class="clock" id="clock">12:00 PM</div>
</div>

<script>
// Config
const SUPABASE_URL = 'https://jereytrwxnuwcvzvqhbg.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcmV5dHJ3eG51d2N2enZxaGJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjI1NzksImV4cCI6MjA4NjQ5ODU3OX0.r0RDnh75IGjECXMwMJNZR0oqF-cEubxbQbjXgavsJ_I'

// Sound Effects using Web Audio API
const audioContext = new (window.AudioContext || window.webkitAudioContext)()

function playSound(type) {
  const oscillator = audioContext.createOscillator()
  const gainNode = audioContext.createGain()
  
  oscillator.connect(gainNode)
  gainNode.connect(audioContext.destination)
  
  switch(type) {
    case 'click':
      oscillator.frequency.value = 800
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime)
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1)
      oscillator.start()
      oscillator.stop(audioContext.currentTime + 0.1)
      break
    case 'success':
      oscillator.frequency.value = 600
      gainNode.gain.setValueAtTime(0.15, audioContext.currentTime)
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3)
      oscillator.start()
      oscillator.stop(audioContext.currentTime + 0.3)
      setTimeout(() => {
        const osc2 = audioContext.createOscillator()
        const gain2 = audioContext.createGain()
        osc2.connect(gain2)
        gain2.connect(audioContext.destination)
        osc2.frequency.value = 800
        gain2.gain.setValueAtTime(0.15, audioContext.currentTime)
        gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3)
        osc2.start()
        osc2.stop(audioContext.currentTime + 0.3)
      }, 150)
      break
    case 'startup':
      const notes = [523.25, 659.25, 783.99, 1046.50] // C, E, G, C
      notes.forEach((freq, i) => {
        setTimeout(() => {
          const osc = audioContext.createOscillator()
          const gain = audioContext.createGain()
          osc.connect(gain)
          gain.connect(audioContext.destination)
          osc.frequency.value = freq
          gain.gain.setValueAtTime(0.1, audioContext.currentTime)
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2)
          osc.start()
          osc.stop(audioContext.currentTime + 0.2)
        }, i * 100)
      })
      break
  }
}

// Add click sound to all buttons
document.addEventListener('click', (e) => {
  if (e.target.matches('button') || e.target.closest('button')) {
    playSound('click')
  }
})

// Clock
function updateClock() {
  const now = new Date()
  document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  })
}
setInterval(updateClock, 1000)
updateClock()

// App State
let allApps = []
let currentCategory = 'all'
let currentSearch = ''

// App Card Generator
function createAppCard(app) {
  const hasUpvoted = localStorage.getItem(`upvoted_${app.id}`)
  const userRating = localStorage.getItem(`rated_${app.id}`)
  const avgRating = app.rating_count > 0 ? (app.rating_sum / app.rating_count).toFixed(1) : null
  
  return `
    <div class="app-window window ${app.featured ? 'featured' : ''}" data-app-id="${app.id}">
      <div class="title-bar">
        <div class="title-bar-text">${app.name}</div>
        <div class="title-bar-controls">
          <button aria-label="Minimize" disabled></button>
          <button aria-label="Close" disabled></button>
        </div>
      </div>
      
      <div class="window-body">
        <div class="app-content">
          <img src="${app.logo_url || 'logo.svg'}" class="app-icon" alt="${app.name}" onerror="this.src='logo.svg'">
          <div class="app-details">
            <div class="app-description">${app.description || 'No description'}</div>
            ${app.tags?.length ? `
              <div class="app-tags">
                ${app.tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="app-footer">
          <button class="upvote-btn ${hasUpvoted ? 'upvoted' : ''}" data-action="upvote">
            üëç <span data-upvote-count>${app.upvotes}</span>
          </button>
          
          <div class="stars-container">
            <div class="stars" data-action="rate">
              ${[1,2,3,4,5].map(i => `
                <button class="star ${userRating && i <= userRating ? 'filled' : ''}" data-rating="${i}">‚òÖ</button>
              `).join('')}
            </div>
            ${avgRating ? `<span class="rating-value">${avgRating}</span>` : ''}
          </div>
          
          <a href="${app.url}" target="_blank" rel="noopener" style="margin-left: auto;">
            <button>Visit</button>
          </a>
        </div>
      </div>
    </div>
  `
}

// Fetch Apps
async function loadApps() {
  const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?order=created_at.desc`, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`
    }
  })
  allApps = await response.json()
  
  // Populate categories dropdown
  const categories = [...new Set(allApps.map(app => app.category).filter(Boolean))].sort()
  const categoryFilter = document.getElementById('category-filter')
  categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')
  
  renderApps()
  updateStats()
}

function renderApps() {
  const container = document.getElementById('app-container')
  let filtered = allApps
  
  // Apply search filter
  if (currentSearch) {
    filtered = filtered.filter(app =>
      app.name.toLowerCase().includes(currentSearch.toLowerCase()) ||
      app.description?.toLowerCase().includes(currentSearch.toLowerCase()) ||
      app.tags?.some(tag => tag.toLowerCase().includes(currentSearch.toLowerCase()))
    )
  }
  
  // Group by category
  if (currentCategory === 'all') {
    const categories = [...new Set(filtered.map(app => app.category || 'Other'))].sort()
    
    container.innerHTML = categories.map(category => {
      const categoryApps = filtered.filter(app => (app.category || 'Other') === category)
      return `
        <div class="category-section">
          <div class="category-header">
            <span>${category}</span>
            <span class="count">${categoryApps.length}</span>
          </div>
          <div class="app-grid">
            ${categoryApps.map(app => createAppCard(app)).join('')}
          </div>
        </div>
      `
    }).join('')
  } else {
    const categoryApps = filtered.filter(app => app.category === currentCategory)
    container.innerHTML = `
      <div class="category-section">
        <div class="category-header">
          <span>${currentCategory}</span>
          <span class="count">${categoryApps.length}</span>
        </div>
        <div class="app-grid">
          ${categoryApps.map(app => createAppCard(app)).join('')}
        </div>
      </div>
    `
  }
}

function updateStats() {
  document.getElementById('total-apps').textContent = allApps.length
  document.getElementById('total-upvotes').textContent = allApps.reduce((sum, app) => sum + app.upvotes, 0)
  const appsWithRatings = allApps.filter(a => a.rating_count > 0)
  const avgRating = appsWithRatings.length > 0
    ? (appsWithRatings.reduce((sum, a) => sum + (a.rating_sum / a.rating_count), 0) / appsWithRatings.length).toFixed(1)
    : '‚Äî'
  document.getElementById('avg-rating').textContent = avgRating
}

// Upvote Handler
document.getElementById('app-container').addEventListener('click', async (e) => {
  const upvoteBtn = e.target.closest('[data-action="upvote"]')
  if (upvoteBtn) {
    e.preventDefault()
    const appId = upvoteBtn.closest('[data-app-id]').dataset.appId
    
    if (localStorage.getItem(`upvoted_${appId}`)) {
      return
    }
    
    // Optimistic update
    const count = upvoteBtn.querySelector('[data-upvote-count]')
    count.textContent = parseInt(count.textContent) + 1
    upvoteBtn.classList.add('upvoted')
    localStorage.setItem(`upvoted_${appId}`, 'true')
    
    playSound('success')
    
    // API call
    await fetch(`${SUPABASE_URL}/rest/v1/votes`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({
        app_id: appId,
        user_fingerprint: 'demo-user-' + Math.random().toString(36).substr(2, 9),
        vote_type: 'upvote'
      })
    }).catch(() => {})
  }
  
  // Star rating handler
  const star = e.target.closest('.star')
  if (star) {
    e.preventDefault()
    const appId = star.closest('[data-app-id]').dataset.appId
    const rating = parseInt(star.dataset.rating)
    
    if (localStorage.getItem(`rated_${appId}`)) {
      return
    }
    
    // Update UI
    const stars = star.closest('.stars').querySelectorAll('.star')
    stars.forEach((s, i) => {
      if (i < rating) s.classList.add('filled')
    })
    localStorage.setItem(`rated_${appId}`, rating)
    
    playSound('success')
    
    // API call
    await fetch(`${SUPABASE_URL}/rest/v1/votes`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({
        app_id: appId,
        user_fingerprint: 'demo-user-' + Math.random().toString(36).substr(2, 9),
        vote_type: 'rating',
        rating_value: rating
      })
    }).catch(() => {})
  }
})

// Search
let searchTimeout
document.getElementById('search-input').addEventListener('input', (e) => {
  clearTimeout(searchTimeout)
  searchTimeout = setTimeout(() => {
    currentSearch = e.target.value
    renderApps()
  }, 300)
})

// Category filter
document.getElementById('category-filter').addEventListener('change', (e) => {
  currentCategory = e.target.value
  renderApps()
})

// Init
loadApps()

// Play startup sound on first interaction
let hasPlayed = false
document.addEventListener('click', () => {
  if (!hasPlayed) {
    playSound('startup')
    hasPlayed = true
  }
}, { once: true })
</script>

</body>
</html>
