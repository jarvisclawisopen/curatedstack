<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CuratedStack - Windows 95 Style</title>
  <link rel="icon" href="logo.svg">
  
  <!-- 98.css Windows 95 Framework -->
  <link rel="stylesheet" href="https://unpkg.com/98.css">
  
  <style>
    body {
      background: teal;
      margin: 0;
      padding: 20px;
      padding-bottom: 50px;
    }
    
    .main-window {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 10px;
    }
    
    .app-window {
      position: relative;
    }
    
    .app-window.featured {
      animation: glow 2s ease-in-out infinite;
    }
    
    .app-window.featured::before {
      content: "‚≠ê FEATURED ‚≠ê";
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: yellow;
      padding: 4px 16px;
      font-weight: bold;
      border: 2px outset;
      z-index: 10;
      animation: bounce 1s ease infinite;
    }
    
    .app-window.featured .title-bar {
      background: linear-gradient(90deg, red, orange, yellow, orange, red);
      background-size: 200% 100%;
      animation: rainbow 3s linear infinite;
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 10px yellow; }
      50% { box-shadow: 0 0 30px yellow; }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-5px); }
    }
    
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    
    .app-icon {
      width: 48px;
      height: 48px;
      object-fit: contain;
    }
    
    .app-content {
      display: flex;
      gap: 12px;
      margin: 8px 0;
    }
    
    .app-details {
      flex: 1;
    }
    
    .app-description {
      font-size: 11px;
      margin: 4px 0;
      color: #000;
    }
    
    .app-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    
    .tag {
      font-size: 9px;
      padding: 2px 6px;
      background: #c0c0c0;
      border: 1px solid #808080;
    }
    
    .app-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #808080;
    }
    
    .upvote-btn {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .upvote-btn.upvoted {
      background: navy;
      color: white;
    }
    
    .stars {
      display: flex;
      gap: 2px;
    }
    
    .star {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      color: #808080;
    }
    
    .star.filled {
      color: gold;
    }
    
    /* Taskbar */
    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 28px;
      display: flex;
      align-items: center;
      padding: 2px;
      gap: 2px;
    }
    
    .start-button {
      padding: 2px 8px !important;
      font-weight: bold !important;
    }
    
    .clock {
      margin-left: auto;
      padding: 2px 8px;
      border: 1px inset;
    }
    
    /* Search Bar */
    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    
    #search-input {
      flex: 1;
      max-width: 400px;
    }
    
    .status-bar-field {
      padding: 2px 8px;
    }
  </style>
</head>
<body>

<!-- Main Application Window -->
<div class="main-window window" style="width: 100%;">
  <div class="title-bar">
    <div class="title-bar-text">
      <img src="logo.svg" width="16" height="16" alt="CuratedStack">
      CuratedStack - Curated Apps Directory
    </div>
    <div class="title-bar-controls">
      <button aria-label="Minimize" disabled></button>
      <button aria-label="Maximize" disabled></button>
      <button aria-label="Close" disabled></button>
    </div>
  </div>
  
  <div class="window-body">
    <!-- Toolbar -->
    <div class="toolbar">
      <label for="search-input">Find:</label>
      <input id="search-input" type="text" placeholder="Search apps..." />
      <button id="search-btn">Search</button>
      <div style="margin-left: auto;">
        <select id="category-filter">
          <option value="all">All Categories</option>
        </select>
      </div>
    </div>
    
    <!-- Stats -->
    <div class="status-bar">
      <div class="status-bar-field">
        <span id="total-apps">0</span> apps
      </div>
      <div class="status-bar-field">
        <span id="total-upvotes">0</span> total upvotes
      </div>
      <div class="status-bar-field">
        Avg rating: <span id="avg-rating">‚Äî</span>‚≠ê
      </div>
    </div>
    
    <!-- App Grid -->
    <div id="app-grid" class="app-grid"></div>
  </div>
</div>

<!-- Taskbar -->
<div class="taskbar window">
  <button class="start-button">
    <b>Start</b>
  </button>
  <div class="clock" id="clock">12:00 PM</div>
</div>

<!-- Audio for sound effects -->
<audio id="sound-click" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
</audio>
<audio id="sound-tada" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQEBAAAAAAD//w==" type="audio/wav">
</audio>

<script>
// Config
const SUPABASE_URL = 'https://jereytrwxnuwcvzvqhbg.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcmV5dHJ3eG51d2N2enZxaGJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjI1NzksImV4cCI6MjA4NjQ5ODU3OX0.r0RDnh75IGjECXMwMJNZR0oqF-cEubxbQbjXgavsJ_I'

// Sound Effects
function playSound(id) {
  const audio = document.getElementById(`sound-${id}`)
  if (audio) {
    audio.currentTime = 0
    audio.play().catch(() => {})
  }
}

// Add click sound to all buttons
document.addEventListener('click', (e) => {
  if (e.target.matches('button')) playSound('click')
})

// Clock
function updateClock() {
  const now = new Date()
  document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  })
}
setInterval(updateClock, 1000)
updateClock()

// App Card Generator
function createAppCard(app) {
  const hasUpvoted = localStorage.getItem(`upvoted_${app.id}`)
  const userRating = localStorage.getItem(`rated_${app.id}`)
  const avgRating = app.rating_count > 0 ? (app.rating_sum / app.rating_count).toFixed(1) : null
  
  return `
    <div class="app-window window ${app.featured ? 'featured' : ''}" data-app-id="${app.id}">
      <div class="title-bar">
        <div class="title-bar-text">${app.name}</div>
        <div class="title-bar-controls">
          <button aria-label="Minimize" disabled></button>
          <button aria-label="Close" disabled></button>
        </div>
      </div>
      
      <div class="window-body">
        <div class="app-content">
          <img src="${app.logo_url || 'logo.svg'}" class="app-icon" alt="${app.name}">
          <div class="app-details">
            <div class="app-description">${app.description || 'No description'}</div>
            ${app.tags?.length ? `
              <div class="app-tags">
                ${app.tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="app-footer">
          <button class="upvote-btn ${hasUpvoted ? 'upvoted' : ''}" data-action="upvote">
            üëç <span data-upvote-count>${app.upvotes}</span>
          </button>
          
          <div class="stars" data-action="rate">
            ${[1,2,3,4,5].map(i => `
              <button class="star ${userRating && i <= userRating ? 'filled' : ''}" data-rating="${i}">‚òÖ</button>
            `).join('')}
            ${avgRating ? `<span style="margin-left:4px;font-size:10px;">${avgRating}</span>` : ''}
          </div>
          
          <a href="${app.url}" target="_blank">
            <button>Visit</button>
          </a>
        </div>
      </div>
    </div>
  `
}

// Fetch Apps
let allApps = []

async function loadApps() {
  const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?order=created_at.desc`, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`
    }
  })
  allApps = await response.json()
  renderApps()
  updateStats()
}

function renderApps() {
  const grid = document.getElementById('app-grid')
  grid.innerHTML = allApps.map(app => createAppCard(app)).join('')
}

function updateStats() {
  document.getElementById('total-apps').textContent = allApps.length
  document.getElementById('total-upvotes').textContent = allApps.reduce((sum, app) => sum + app.upvotes, 0)
  const appsWithRatings = allApps.filter(a => a.rating_count > 0)
  const avgRating = appsWithRatings.length > 0
    ? (appsWithRatings.reduce((sum, a) => sum + (a.rating_sum / a.rating_count), 0) / appsWithRatings.length).toFixed(1)
    : '‚Äî'
  document.getElementById('avg-rating').textContent = avgRating
}

// Upvote Handler
document.getElementById('app-grid').addEventListener('click', async (e) => {
  const upvoteBtn = e.target.closest('[data-action="upvote"]')
  if (upvoteBtn) {
    e.preventDefault()
    const appId = upvoteBtn.closest('[data-app-id]').dataset.appId
    
    if (localStorage.getItem(`upvoted_${appId}`)) {
      alert('You already upvoted this app!')
      return
    }
    
    // Optimistic update
    const count = upvoteBtn.querySelector('[data-upvote-count]')
    count.textContent = parseInt(count.textContent) + 1
    upvoteBtn.classList.add('upvoted')
    localStorage.setItem(`upvoted_${appId}`, 'true')
    
    playSound('tada')
    
    // API call (simplified - real implementation would use fingerprint)
    await fetch(`${SUPABASE_URL}/rest/v1/votes`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        app_id: appId,
        user_fingerprint: 'demo-user',
        vote_type: 'upvote'
      })
    })
  }
  
  // Star rating handler
  const star = e.target.closest('.star')
  if (star) {
    e.preventDefault()
    const appId = star.closest('[data-app-id]').dataset.appId
    const rating = parseInt(star.dataset.rating)
    
    if (localStorage.getItem(`rated_${appId}`)) {
      alert('You already rated this app!')
      return
    }
    
    // Update UI
    const stars = star.closest('.stars').querySelectorAll('.star')
    stars.forEach((s, i) => {
      if (i < rating) s.classList.add('filled')
    })
    localStorage.setItem(`rated_${appId}`, rating)
    
    playSound('tada')
    
    // API call
    await fetch(`${SUPABASE_URL}/rest/v1/votes`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        app_id: appId,
        user_fingerprint: 'demo-user',
        vote_type: 'rating',
        rating_value: rating
      })
    })
  }
})

// Search
document.getElementById('search-input').addEventListener('input', (e) => {
  const query = e.target.value.toLowerCase()
  const filtered = allApps.filter(app => 
    app.name.toLowerCase().includes(query) ||
    app.description?.toLowerCase().includes(query) ||
    app.tags?.some(tag => tag.toLowerCase().includes(query))
  )
  document.getElementById('app-grid').innerHTML = filtered.map(app => createAppCard(app)).join('')
})

// Init
loadApps()
</script>

</body>
</html>
