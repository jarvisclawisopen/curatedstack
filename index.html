<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CuratedStack - Windows 95 Style</title>
  <link rel="icon" href="logo.svg">
  
  <!-- 98.css Windows 95 Framework -->
  <link rel="stylesheet" href="https://unpkg.com/98.css">
  
  <style>
    body {
      background: teal;
      margin: 0;
      padding: 20px;
      padding-bottom: 50px;
    }
    
    .main-window {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Category Colors */
    .category-section[data-category="AI"] .window-body { background: #ffe4e1; }
    .category-section[data-category="Development"] .window-body { background: #e1f5fe; }
    .category-section[data-category="Design"] .window-body { background: #f3e5f5; }
    .category-section[data-category="Productivity"] .window-body { background: #fff9c4; }
    .category-section[data-category="Marketing"] .window-body { background: #e8f5e9; }
    .category-section[data-category="Analytics"] .window-body { background: #fce4ec; }
    .category-section[data-category="Communication"] .window-body { background: #e0f2f1; }
    .category-section[data-category="Other"] .window-body { background: #f5f5f5; }
    
    /* Category Sections */
    .category-section {
      margin-bottom: 30px;
    }
    
    .category-header {
      background: linear-gradient(90deg, #000080, #1084d0);
      color: white;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 12px;
      border: 2px solid;
      border-color: #ffffff #000000 #000000 #ffffff;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .category-header:hover {
      background: linear-gradient(90deg, #1084d0, #000080);
    }
    
    .category-header .count {
      background: yellow;
      color: black;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }
    
    /* App Window */
    .app-window {
      position: relative;
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    
    .app-window:hover {
      transform: translateY(-2px);
      filter: brightness(1.05);
    }
    
    .app-window:active {
      transform: translateY(0);
    }
    
    /* Featured App */
    .app-window.featured {
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    }
    
    .app-window.featured::before {
      content: "‚≠ê FEATURED";
      position: absolute;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
      background: yellow;
      color: black;
      padding: 3px 12px;
      font-weight: bold;
      font-size: 10px;
      border: 2px outset;
      z-index: 10;
    }
    
    .app-window.featured .title-bar {
      background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
      background-size: 200% 100%;
      animation: rainbow-slide 4s linear infinite;
    }
    
    @keyframes rainbow-slide {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    
    .app-icon {
      width: 48px;
      height: 48px;
      object-fit: contain;
      border: 1px solid #808080;
      background: white;
      flex-shrink: 0;
    }
    
    .app-icon.loading {
      background: linear-gradient(90deg, #c0c0c0 0%, #ffffff 50%, #c0c0c0 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -100% 0; }
      100% { background-position: 100% 0; }
    }
    
    .app-content {
      display: flex;
      gap: 12px;
      margin: 8px 0;
    }
    
    .app-details {
      flex: 1;
      min-width: 0;
    }
    
    .app-name {
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .app-description {
      font-size: 11px;
      margin: 4px 0;
      color: #000;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .app-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    
    .tag {
      font-size: 9px;
      padding: 2px 6px;
      background: #c0c0c0;
      border: 1px solid #808080;
      white-space: nowrap;
    }
    
    .app-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #808080;
    }
    
    .upvote-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
      padding: 2px 8px !important;
    }
    
    .upvote-btn.upvoted {
      background: navy !important;
      color: white;
    }
    
    .rating-display {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      white-space: nowrap;
    }
    
    .stars-small {
      color: gold;
    }
    
    /* Modal */
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      animation: fadeIn 0.2s ease;
    }
    
    .modal-backdrop.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-window {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      z-index: 9999;
      animation: windowOpen 0.3s ease;
    }
    
    .modal-window.active {
      display: block;
    }
    
    @keyframes windowOpen {
      0% {
        transform: translate(-50%, -50%) scale(0.7);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }
    
    .modal-body {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px groove;
    }
    
    .modal-icon {
      width: 64px;
      height: 64px;
      object-fit: contain;
      border: 1px solid #808080;
      background: white;
    }
    
    .modal-info {
      flex: 1;
    }
    
    .modal-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .modal-category {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .modal-description {
      font-size: 12px;
      line-height: 1.6;
      margin: 12px 0;
    }
    
    .modal-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 12px 0;
    }
    
    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 2px groove;
      justify-content: space-between;
      align-items: center;
    }
    
    .rating-stars {
      display: flex;
      gap: 4px;
    }
    
    .star-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      color: #c0c0c0;
      transition: transform 0.1s;
    }
    
    .star-btn:hover {
      transform: scale(1.2);
    }
    
    .star-btn.filled {
      color: gold;
    }
    
    /* Taskbar */
    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 28px;
      display: flex;
      align-items: center;
      padding: 2px;
      gap: 2px;
      z-index: 9999;
    }
    
    .start-button {
      padding: 2px 8px !important;
      font-weight: bold !important;
    }
    
    .clock {
      margin-left: auto;
      padding: 2px 8px;
      border: 1px inset;
      font-size: 11px;
    }
    
    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    #search-input {
      flex: 1;
      max-width: 300px;
      min-width: 200px;
    }
    
    #category-filter {
      min-width: 150px;
    }
    
    .status-bar-field {
      padding: 2px 8px;
    }
  </style>
</head>
<body>

<!-- Main Application Window -->
<div class="main-window window" style="width: 100%;">
  <div class="title-bar">
    <div class="title-bar-text">
      <img src="logo.svg" width="16" height="16" alt="CuratedStack" onerror="this.style.display='none'">
      CuratedStack - Curated Apps Directory
    </div>
    <div class="title-bar-controls">
      <button aria-label="Minimize" disabled></button>
      <button aria-label="Maximize" disabled></button>
      <button aria-label="Close" disabled></button>
    </div>
  </div>
  
  <div class="window-body">
    <!-- Toolbar -->
    <div class="toolbar">
      <label for="search-input">Find:</label>
      <input id="search-input" type="text" placeholder="Search apps..." />
      <button id="search-btn">Search</button>
      <select id="category-filter">
        <option value="all">All Categories</option>
      </select>
    </div>
    
    <!-- Stats -->
    <div class="status-bar">
      <div class="status-bar-field">
        <span id="total-apps">0</span> apps
      </div>
      <div class="status-bar-field">
        <span id="total-upvotes">0</span> total upvotes
      </div>
      <div class="status-bar-field">
        Avg rating: <span id="avg-rating">‚Äî</span>‚≠ê
      </div>
    </div>
    
    <!-- App Grid (categorized) -->
    <div id="app-container"></div>
  </div>
</div>

<!-- Modal Window -->
<div class="modal-backdrop" id="modal-backdrop"></div>
<div class="modal-window window" id="modal-window">
  <div class="title-bar">
    <div class="title-bar-text" id="modal-window-title">App Details</div>
    <div class="title-bar-controls">
      <button aria-label="Close" id="modal-close"></button>
    </div>
  </div>
  
  <div class="window-body modal-body" id="modal-content">
    <!-- Dynamic content -->
  </div>
</div>

<!-- Taskbar -->
<div class="taskbar window">
  <button class="start-button" onclick="playSound('startup')">
    <b>Start</b>
  </button>
  <div class="clock" id="clock">12:00 PM</div>
</div>

<script>
// Config
const SUPABASE_URL = 'https://jereytrwxnuwcvzvqhbg.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcmV5dHJ3eG51d2N2enZxaGJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjI1NzksImV4cCI6MjA4NjQ5ODU3OX0.r0RDnh75IGjECXMwMJNZR0oqF-cEubxbQbjXgavsJ_I'

// Sound Effects using Web Audio API
const audioContext = new (window.AudioContext || window.webkitAudioContext)()

function playSound(type) {
  const oscillator = audioContext.createOscillator()
  const gainNode = audioContext.createGain()
  
  oscillator.connect(gainNode)
  gainNode.connect(audioContext.destination)
  
  switch(type) {
    case 'click':
      oscillator.frequency.value = 800
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime)
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05)
      oscillator.start()
      oscillator.stop(audioContext.currentTime + 0.05)
      break
    case 'open':
      oscillator.frequency.value = 523
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime)
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2)
      oscillator.start()
      oscillator.stop(audioContext.currentTime + 0.2)
      break
    case 'close':
      oscillator.frequency.value = 392
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime)
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15)
      oscillator.start()
      oscillator.stop(audioContext.currentTime + 0.15)
      break
    case 'success':
      const notes = [523, 659] // C, E
      notes.forEach((freq, i) => {
        setTimeout(() => {
          const osc = audioContext.createOscillator()
          const gain = audioContext.createGain()
          osc.connect(gain)
          gain.connect(audioContext.destination)
          osc.frequency.value = freq
          gain.gain.setValueAtTime(0.15, audioContext.currentTime)
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2)
          osc.start()
          osc.stop(audioContext.currentTime + 0.2)
        }, i * 100)
      })
      break
    case 'startup':
      const startupNotes = [523, 659, 784, 1047] // C, E, G, C
      startupNotes.forEach((freq, i) => {
        setTimeout(() => {
          const osc = audioContext.createOscillator()
          const gain = audioContext.createGain()
          osc.connect(gain)
          gain.connect(audioContext.destination)
          osc.frequency.value = freq
          gain.gain.setValueAtTime(0.1, audioContext.currentTime)
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15)
          osc.start()
          osc.stop(audioContext.currentTime + 0.15)
        }, i * 80)
      })
      break
  }
}

// Add click sound to buttons
document.addEventListener('click', (e) => {
  if (e.target.matches('button:not(.star-btn)') || e.target.closest('button:not(.star-btn)')) {
    playSound('click')
  }
})

// Clock
function updateClock() {
  const now = new Date()
  document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  })
}
setInterval(updateClock, 1000)
updateClock()

// App State
let allApps = []
let currentCategory = 'all'
let currentSearch = ''

// Generate favicon URL
function getFaviconUrl(url) {
  try {
    const domain = new URL(url).hostname
    return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`
  } catch (e) {
    return 'logo.svg'
  }
}

// App Card Generator
function createAppCard(app) {
  const hasUpvoted = localStorage.getItem(`upvoted_${app.id}`)
  const userRating = parseInt(localStorage.getItem(`rated_${app.id}`)) || 0
  const avgRating = app.rating_count > 0 ? (app.rating_sum / app.rating_count).toFixed(1) : null
  
  const faviconUrl = app.logo_url || getFaviconUrl(app.url)
  
  return `
    <div class="app-window window ${app.featured ? 'featured' : ''}" data-app-id="${app.id}" onclick="openModal('${app.id}')">
      <div class="title-bar">
        <div class="title-bar-text">${app.name}</div>
        <div class="title-bar-controls">
          <button aria-label="Minimize" disabled></button>
          <button aria-label="Close" disabled></button>
        </div>
      </div>
      
      <div class="window-body">
        <div class="app-content">
          <img src="${faviconUrl}" class="app-icon loading" alt="${app.name}" 
               onerror="this.src='logo.svg'; this.classList.remove('loading')"
               onload="this.classList.remove('loading')">
          <div class="app-details">
            <div class="app-description">${app.description || 'No description available'}</div>
            ${app.tags?.length ? `
              <div class="app-tags">
                ${app.tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="app-footer">
          <button class="upvote-btn ${hasUpvoted ? 'upvoted' : ''}" 
                  onclick="event.stopPropagation(); handleUpvote('${app.id}', this)">
            üëç <span>${app.upvotes}</span>
          </button>
          
          <div class="rating-display">
            ${avgRating ? `<span class="stars-small">‚òÖ</span><b>${avgRating}</b>` : '<span style="color:#999">No ratings</span>'}
          </div>
        </div>
      </div>
    </div>
  `
}

// Modal Functions
function openModal(appId) {
  playSound('open')
  const app = allApps.find(a => a.id === appId)
  if (!app) return
  
  const userRating = parseInt(localStorage.getItem(`rated_${app.id}`)) || 0
  const hasUpvoted = localStorage.getItem(`upvoted_${app.id}`)
  const avgRating = app.rating_count > 0 ? (app.rating_sum / app.rating_count).toFixed(1) : null
  const faviconUrl = app.logo_url || getFaviconUrl(app.url)
  
  const modalContent = `
    <div class="modal-header">
      <img src="${faviconUrl}" class="modal-icon" alt="${app.name}"
           onerror="this.src='logo.svg'">
      <div class="modal-info">
        <div class="modal-title">${app.name}</div>
        <div class="modal-category">${app.category || 'Uncategorized'}</div>
        ${app.tags?.length ? `
          <div class="modal-tags">
            ${app.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
        ` : ''}
      </div>
    </div>
    
    <div class="modal-description">
      ${app.description || 'No description available'}
    </div>
    
    <div class="modal-actions">
      <div>
        <button class="upvote-btn ${hasUpvoted ? 'upvoted' : ''}" 
                onclick="handleUpvote('${app.id}', this)">
          üëç <span>${app.upvotes}</span>
        </button>
      </div>
      
      <div style="text-align: center;">
        <div style="margin-bottom: 4px; font-size: 11px;">Rate this app:</div>
        <div class="rating-stars">
          ${[1,2,3,4,5].map(i => `
            <button class="star-btn ${userRating >= i ? 'filled' : ''}" 
                    onclick="handleRating('${app.id}', ${i}, this)"
                    data-rating="${i}">‚òÖ</button>
          `).join('')}
        </div>
        ${avgRating ? `<div style="font-size: 11px; margin-top: 4px; color: #666;">Average: ${avgRating}‚≠ê</div>` : ''}
      </div>
      
      <div>
        <a href="${app.url}" target="_blank" rel="noopener">
          <button><b>Visit Website</b></button>
        </a>
      </div>
    </div>
  `
  
  document.getElementById('modal-content').innerHTML = modalContent
  document.getElementById('modal-window-title').textContent = app.name
  document.getElementById('modal-backdrop').classList.add('active')
  document.getElementById('modal-window').classList.add('active')
}

function closeModal() {
  playSound('close')
  document.getElementById('modal-backdrop').classList.remove('active')
  document.getElementById('modal-window').classList.remove('active')
}

document.getElementById('modal-close').addEventListener('click', closeModal)
document.getElementById('modal-backdrop').addEventListener('click', closeModal)

// Escape key to close modal
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal()
})

// Upvote Handler
async function handleUpvote(appId, btn) {
  if (localStorage.getItem(`upvoted_${appId}`)) {
    return
  }
  
  // Optimistic update
  const countSpan = btn.querySelector('span')
  countSpan.textContent = parseInt(countSpan.textContent) + 1
  btn.classList.add('upvoted')
  localStorage.setItem(`upvoted_${appId}`, 'true')
  
  playSound('success')
  
  // Update in allApps
  const app = allApps.find(a => a.id === appId)
  if (app) app.upvotes++
  
  // API call
  await fetch(`${SUPABASE_URL}/rest/v1/votes`, {
    method: 'POST',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify({
      app_id: appId,
      user_fingerprint: 'demo-user-' + Math.random().toString(36).substr(2, 9),
      vote_type: 'upvote'
    })
  }).catch(() => {})
  
  updateStats()
}

// Rating Handler
async function handleRating(appId, rating, btn) {
  const existingRating = localStorage.getItem(`rated_${appId}`)
  if (existingRating) {
    return // Already rated
  }
  
  // Update UI
  const stars = btn.parentElement.querySelectorAll('.star-btn')
  stars.forEach((star, i) => {
    if (i < rating) {
      star.classList.add('filled')
    }
  })
  
  localStorage.setItem(`rated_${appId}`, rating)
  playSound('success')
  
  // Update in allApps
  const app = allApps.find(a => a.id === appId)
  if (app) {
    app.rating_sum += rating
    app.rating_count++
  }
  
  // API call
  await fetch(`${SUPABASE_URL}/rest/v1/votes`, {
    method: 'POST',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify({
      app_id: appId,
      user_fingerprint: 'demo-user-' + Math.random().toString(36).substr(2, 9),
      vote_type: 'rating',
      rating_value: rating
    })
  }).catch(() => {})
  
  updateStats()
}

// Fetch Apps
async function loadApps() {
  const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?order=featured.desc,upvotes.desc`, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`
    }
  })
  allApps = await response.json()
  
  // Populate categories dropdown
  const categories = [...new Set(allApps.map(app => app.category).filter(Boolean))].sort()
  const categoryFilter = document.getElementById('category-filter')
  categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')
  
  renderApps()
  updateStats()
}

function renderApps() {
  const container = document.getElementById('app-container')
  let filtered = allApps
  
  // Apply search filter
  if (currentSearch) {
    filtered = filtered.filter(app =>
      app.name.toLowerCase().includes(currentSearch.toLowerCase()) ||
      app.description?.toLowerCase().includes(currentSearch.toLowerCase()) ||
      app.tags?.some(tag => tag.toLowerCase().includes(currentSearch.toLowerCase()))
    )
  }
  
  // Group by category
  if (currentCategory === 'all') {
    const categories = [...new Set(filtered.map(app => app.category || 'Other'))].sort()
    
    container.innerHTML = categories.map(category => {
      const categoryApps = filtered.filter(app => (app.category || 'Other') === category)
      return `
        <div class="category-section" data-category="${category}">
          <div class="category-header">
            <span>${category}</span>
            <span class="count">${categoryApps.length}</span>
          </div>
          <div class="app-grid">
            ${categoryApps.map(app => createAppCard(app)).join('')}
          </div>
        </div>
      `
    }).join('')
  } else {
    const categoryApps = filtered.filter(app => app.category === currentCategory)
    container.innerHTML = `
      <div class="category-section" data-category="${currentCategory}">
        <div class="category-header">
          <span>${currentCategory}</span>
          <span class="count">${categoryApps.length}</span>
        </div>
        <div class="app-grid">
          ${categoryApps.map(app => createAppCard(app)).join('')}
        </div>
      </div>
    `
  }
}

function updateStats() {
  document.getElementById('total-apps').textContent = allApps.length
  document.getElementById('total-upvotes').textContent = allApps.reduce((sum, app) => sum + app.upvotes, 0)
  const appsWithRatings = allApps.filter(a => a.rating_count > 0)
  const avgRating = appsWithRatings.length > 0
    ? (appsWithRatings.reduce((sum, a) => sum + (a.rating_sum / a.rating_count), 0) / appsWithRatings.length).toFixed(1)
    : '‚Äî'
  document.getElementById('avg-rating').textContent = avgRating
}

// Search
let searchTimeout
document.getElementById('search-input').addEventListener('input', (e) => {
  clearTimeout(searchTimeout)
  searchTimeout = setTimeout(() => {
    currentSearch = e.target.value
    renderApps()
  }, 300)
})

document.getElementById('search-btn').addEventListener('click', () => {
  currentSearch = document.getElementById('search-input').value
  renderApps()
})

// Category filter
document.getElementById('category-filter').addEventListener('change', (e) => {
  currentCategory = e.target.value
  renderApps()
})

// Init
loadApps()

// Play startup sound on first interaction
let hasPlayed = false
document.addEventListener('click', () => {
  if (!hasPlayed) {
    playSound('startup')
    hasPlayed = true
  }
}, { once: true })
</script>

</body>
</html>
